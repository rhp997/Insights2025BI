<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Table of Contents</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <style>
        :root {
            /* Define the custom blue color as a variable */
            --custom-blue: rgb(49, 144, 214);
            /* Define a dark gray for primary text/background */
            --custom-dark-gray: #343a40;
            /* Define a light gray for background */
            --custom-light-gray: #f8f9fa;
        }

        body {
            background-color: var(--custom-light-gray);
            color: var(--custom-dark-gray);
            /* Default text color is dark gray */
        }

        /* The blue color for headers */
        h1,
        h2,
        h3,
        h4,
        .text-blue {
            color: var(--custom-blue) !important;
        }

        /* Style for the custom blue button */
        .btn-custom-blue {
            color: #fff;
            background-color: var(--custom-blue);
            border-color: var(--custom-blue);
        }

        .btn-custom-blue:hover {
            color: #fff;
            background-color: rgb(40, 115, 171);
            /* Slightly darker blue on hover */
            border-color: rgb(40, 115, 171);
        }

        /* Style for anchor tags that are not buttons */
        a {
            color: var(--custom-blue);
        }

        a:hover {
            color: rgb(40, 115, 171);
            /* Slightly darker blue on hover */
        }

        /* Use a subtle border for the content container */
        .content-container {
            border: 1px solid #dee2e6;
            background-color: #fff;
        }

        /* Styling for the image elements */
        .img-thumbnail-custom {
            max-height: 300px;
            width: auto;
            border: 1px solid var(--custom-blue);
            /* Blue border for images */
        }

        /* Custom styling for the code block with copy button */
        .code-snippet-container {
            position: relative;
            margin-top: 1rem;
            /* Ensure it appears below the description */
        }

        .copy-btn {
            position: absolute;
            top: 0.5rem;
            right: 1.2rem;
            z-index: 10;
        }

        /* Styling for pre and code to look like a console/snippet */
        .code-snippet-container pre {
            /* Adjust padding to prevent copy button from overlapping code */
            padding-top: 2.5rem !important;
            /* Set fixed height and enable vertical scrolling */
            max-height: 500px;
            overflow-y: scroll;
        }

        .code-snippet-container code {
            /* Preserve white space and line breaks */
            white-space: pre;
            overflow-x: auto;
            display: block;
        }

        /* The original image process styles were not used in the body, but kept for completeness based on original file */
        .error-container {
            border: 1px solid #495057;
            background-color: #dadee2;
        }

        #img-process {
            width: 350px;
            height: 489px;
            background-size: cover;
            background-position: center;
            transition: background-image 0.5s ease-in-out;
            background-image: url("images/google-maps-thumb.webp");
        }

        #img-process:hover {
            background-image: url("images/yardMap-thumb.png");
        }
    </style>
</head>

<body class="p-4">
    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-lg-10 content-container p-4 p-md-5 rounded-3 shadow">

                <header class="text-center mb-4">
                    <h1 class="display-3 fw-bold mb-3 text-blue">
                        Epicor Insights 2025
                    </h1>
                    <h2>Advanced BI Session</h2>
                    <p class="lead">
                        The goal of this presentation is to provide Bistrack BI developers with a set of tools to help
                        solve real problems with actionable data. Much of the focus will be on web-based technologies
                        such as HTML, CSS, and JSON. As Bistrack continues to mature as a web platform, this tech stack
                        is all the more relevant.</p>
                    <p class="lead">
                        As each business is unique and one-size-fits-all applications rarely work for everyone, we hope
                        to provide tools instead of full-blown applications. Thus, the provided examples will be
                        minimalist to outline a concept. </p>
                    <p class="lead fst-italic">Some assembly required.
                    </p>
                </header>

                <hr class="mb-5">

                <!-- Begin SVG Dashboards -->
                <section class="mb-5">
                    <h2 class="mb-3">SVG Dashboards</h2>
                    <p>Examples 1 & 2 contain mostly the same elements. Both have tooltips generated by Bootstrap
                        Javascript and the aqua section contains a hover CSS effect. The main difference is in the way
                        the SVG is loaded. Example 1 contains additional text elements. Example 3 loads an SVG file into
                        an object element and adds a new path element for the "e" on top of the existing SVG.
                        Manipulating SVG inside an object element has a few idiosyncrasies as evidenced in the
                        Javascript.
                    </p>

                    <div class="row row-cols-1 row-cols-md-3 g-4 mt-3">
                        <div class="col">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-body">
                                    <h5 class="card-title">Example 1</h5>
                                    <p class="card-text">
                                        The SVG for this example was derived from three BisTrack Smart Objects using <a
                                            href="sql/svg-json.sql"
                                            class="btn btn-sm btn-outline-secondary py-0 px-2"><i
                                                class="bi bi-download"></i>SQL</a>. The returned
                                        JSON is stored in the "data"
                                        variable and built by looping through the JSON elements.
                                    </p>
                                    <a href="svg-example1.html" class="btn btn-sm btn-custom-blue"><i
                                            class="bi bi-arrow-right-circle me-2"></i>View Example 1</a>
                                </div>
                            </div>
                        </div>

                        <div class="col">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-body">
                                    <h5 class="card-title">Example 2</h5>
                                    <p class="card-text">
                                        The SVG for this example was saved as a <a href="images/lbb-plain.svg"
                                            class="btn btn-sm btn-outline-secondary py-0 px-2"><i
                                                class="bi bi-card-image"></i>.SVG</a>
                                        file and loaded with AJAX. The lbb-plain.svg file was edited with a text editor
                                        to add tooltips. The third path element under the "Extras_Group" group contains
                                        an example:
                                    </p>
                                    <pre
                                        class="bg-light p-2 rounded"><code>data-bs-toggle="tooltip" data-bs-html="true" title="&amp;lt;H1&amp;gt;Beware the Sun!&amp;lt;/H1&amp;gt;" </code></pre>
                                    <p><i>* Note how the HTML tags are escaped using <code>&amp;lt;</code> and
                                            <code>&amp;gt;</code></i>.</p>
                                    <a href="svg-example2.html" class="btn btn-sm btn-custom-blue"><i
                                            class="bi bi-arrow-right-circle me-2"></i>View Example 2</a>
                                </div>
                            </div>
                        </div>

                        <div class="col">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-body">
                                    <h5 class="card-title">Example 3</h5>
                                    <p class="card-text">
                                        The SVG for this example was loaded into an <code>&lt;object&gt;</code> element
                                        from an external SVG file. A new path element was created and added to the SVG
                                        document to draw over the existing "e" in the Epicor logo. A button toggles the
                                        visibility of this new path element and demonstrates how to manipulate SVG
                                        content inside an object element.
                                    </p>
                                    <a href="svg-example3.html" class="btn btn-sm btn-custom-blue"><i
                                            class="bi bi-arrow-right-circle me-2"></i>View Example 3</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                <!-- End SVG Dashboards -->
                <!-- Example 3 Code Block -->
                <h4 class="mt-4 mb-2">SVG Example 3 Code</h4>
                <div class="code-snippet-container mb-5">
                    <button class="btn btn-sm btn-custom-blue copy-btn" data-clipboard-target="#fusion-code"
                        onclick="copyCode(this)">
                        <i class="bi bi-clipboard me-1"></i>Copy
                    </button>
                    <pre class="bg-dark text-white p-3 rounded-3 shadow">
<code id="fusion-code">
// Simple function to toggle visibility of all SVG elements in a group by group name
function togglePathVis(pathID) {
    // Inside an object element, we need to get the SVG document first
    const svgObject = document.getElementById('svg-container');
    const svgDoc = svgObject.getSVGDocument();
    const extras = svgDoc.getElementById(`${pathID}`);
    if (!extras || extras.length === 0) {
        console.warn(`No elements found with id="${pathID}"`);
        return;
    }
    if (extras.style) {
        if (extras.style.display === 'none') {
            extras.style.display = '';
        } else {
            extras.style.display = 'none';
        }
        return;
    }
}

const svgObject = document.getElementById('svg-container');
svgObject.addEventListener('load', function () {
    // Note: For files that are not locally hosted, CORS policies may prevent access to the document object
    const svgDoc = svgObject.getSVGDocument();
    if (svgDoc) {
        const ns = 'http://www.w3.org/2000/svg';
        const eObj = svgDoc.createElementNS(ns, 'path');
        // Used Inkscape to derive this path data for the "e" shape; draw over the existing "e" in the logo
        const ePath = "M 5.129,0.367 C 2.333,0.367 0.76,1.983 0.76,4.735 v 8.822 c 0,2.795 1.616,4.368 4.368,4.368 h 16.95 V 14.213 H 6.005 A 0.918,0.918 0 0 1 5.087,13.295 V 4.997 a 0.917,0.917 0 0 1 0.918,-0.96 h 11.268 a 0.917,0.917 0 0 1 0.96,0.96 v 1.616 a 0.874,0.874 0 0 1 -0.96,0.872 H 6.882 v 3.713 H 18.19 c 2.795,0 4.367,-1.66 4.367,-4.368 V 4.735 c 0,-2.795 -1.616,-4.368 -4.367,-4.368 z";
        eObj.setAttribute('d', ePath);
        // Make the new element red and assign an ID for toggling
        eObj.setAttribute('fill', '#ff0000');
        eObj.setAttribute('id', 'newE');
        svgDoc.documentElement.appendChild(eObj);
    } else {
        console.error('Unable to access SVG document. This may be due to CORS restrictions.');
    }
});
</code>
</pre>
                </div>
                <!-- End Example 3 Code Block -->
                <hr class="my-5">

                <!-- Begin Charting -->
                <section class="mb-5">
                    <h2 class="mb-4">Charting</h2>

                    <div class="d-flex flex-column flex-md-row mb-5">
                        <div class="me-md-4 mb-3 mb-md-0 text-center">
                            <a href="images/example-db-main3.png">
                                <img src="images/example-db-main3.png"
                                    class="img-fluid img-thumbnail img-thumbnail-custom"
                                    alt="FusionCharts Example Dashboard">
                            </a>
                        </div>
                        <div>
                            <h3 class="mt-0 mb-3">FusionCharts</h3>
                            <p>
                                Import the <a href="dashboards/main.xml" download
                                    class="btn btn-sm btn-outline-secondary py-0 px-2"><i class="bi bi-download"></i>
                                    Main Example Dashboard XML</a> into BisTrack to see examples of manipulating
                                FusionCharts charts using JavaScript. Charts can be overwritten or created new. This
                                example also contains a DataTable component from <a href="https://datatables.net/"
                                    target="_blank" class="btn btn-sm btn-outline-secondary py-0 px-2"><i
                                        class="bi bi-link-45deg"></i>datatables.net</a>.<br>
                                <a href="#CreatingJSON" class="btn btn-sm btn-custom-blue"><i
                                        class="bi bi-arrow-right-circle me-2"></i>View Main Dashboard SQL</a>
                            </p>
                        </div>
                    </div>

                    <!-- FusionCharts Code Block -->
                    <h4 class="mt-4 mb-2">Dashboard Javascript</h4>
                    <div class="code-snippet-container mb-5">
                        <button class="btn btn-sm btn-custom-blue copy-btn" data-clipboard-target="#fusion-code"
                            onclick="copyCode(this)">
                            <i class="bi bi-clipboard me-1"></i>Copy
                        </button>
                        <pre class="bg-dark text-white p-3 rounded-3 shadow">
<code id="fusion-code">
/* Load scripts first:
src="https://cdn.datatables.net/2.3.4/js/dataTables.js">
src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous">
*/
/* ----------------------------
    Description: Passed a data table ID and a (1-based) column index, returns a promise
    that resolves to a JSON object for the column. Allows dashboards to utilize queries
    that return JSON objects in multiple columns.
---------------------------- */
function loadJsonFromDTCol(DataTableID, colIndex) {
    return new Promise((resolve, reject) => {
        // Use jQuery to select the table cell at the specified index
        const col = $(".Table" + DataTableID + " td:nth-child(" + colIndex + ")");
        // Check if the table element exists and has content
        if (col) {
            if (col.length > 0) {
                // The replace regex was in the original, but probably not needed here?
                const colData = col[0].innerHTML
                    .replace(/(?:\r\n|\r|\n)/g, "")
                    .replace(/\t/g, "")
                    .replaceAll(/[ ]{2,}/g, " ");
                if (colData.length > 0) {
                    try {
                        resolve(JSON.parse(colData));
                    } catch (error) {
                        reject(
                            new Error(
                                `Failed to parse JSON from column data: ${error.message}`
                            )
                        );
                    }
                } else {
                    reject(
                        new Error(
                            `Column data for Table${DataTableID}, index ${colIndex} is empty`
                        )
                    );
                }
            } else {
                reject(
                    new Error(
                        `Unable to locate DOM element Table${DataTableID}; check ID`
                    )
                );
            }
        }
    });
}

/* Change chart type when the radio button is checked */
function handleRadioChange(e) {
    setChartType(e.value);
}

function setChartType(newtype) {
    // Use the second chart; could also use FusionCharts(fusionChartId) if id is known
    const testchart = Object.values(FusionCharts.items)[1];
    //const testchart = FusionCharts(fusionChartId);
    testchart.chartType(newtype);
}

// Global variable. Datatable component ID; update index to match order on Dashboard
const compID = $('div[class^="Component"]')[4].id;

$(document).ready(function () {
    // Load column 3 data
    loadJsonFromDTCol(compID, 3)
        .then(function (data) {
            // Initialize DataTable with the loaded data
            const table = $('#orderTable').DataTable({
                paging: true,
                data: data,
                columns: [
                    { data: 'BranchName' },
                    { data: 'OrderID' },
                    { data: 'OrderNumber' },
                    { data: 'DateTimeCreated' },
                    // Format TotalSellPrice as currency
                    { data: 'TotalSellPrice', render: $.fn.dataTable.render.number(',', '.', 2, '$') },
                    { data: 'OrderStatus' }
                ]
            });
            // Make each row clickable with a pointer cursor
            $('#orderTable tbody').css('cursor', 'pointer').on('click', 'tr', function () {
                // Get the full data object for the clicked row
                const rowData = table.row(this).data();
                if (rowData) {
                    // Create our drilldown link using OrderID and BranchName
                    const customURL = "dislinkDrillDown209393%C3%82%C2%A0%drilldownID1%=" + rowData.OrderID + "%C3%82%C2%A0%drilldowncaption%='" + rowData.BranchName + "'%C3%82%C2%A0";
                    console.log(customURL);
                    window.location.href = customURL;
                }
            });
        })
        .catch(function (error) {
            console.error(error.message);
        });

});

FusionCharts.ready(function () {
    // Calculate new dimensions for the charts; provide a small gap
    const newWidth = (window.innerWidth - 15) / 2;
    const newHeight = (window.innerHeight - 15) / 2;
    // Use the JSON in column 1 to overwrite the pie chart
    loadJsonFromDTCol(compID, 1)
        .then(function (data) {
            // Pie chart component ID
            const cID = "209391";
            // Chart ID is prefixed with "fc"
            const chartID = "fc" + cID;
            // Get the current chart object
            const myChart = FusionCharts(chartID);
            // Resize after render to ensure proper layout
            myChart.addEventListener('rendered', function () {
                $('#' + cID).css({
                    'float': 'left',
                    'width': newWidth + 'px',
                    'height': newHeight + 'px',
                });
                myChart.resizeTo(newWidth, newHeight);
            });
            // Set the new data
            myChart.setJSONData(data);
        })
        .catch(function (error) {
            console.error(error.message);
        });
    // Use the JSON in column 2 to overwrite the line chart
    loadJsonFromDTCol(compID, 2)
        .then(function (data) {
            const cID = "209392";
            const chartID = "fc" + cID;
            const myChart = FusionCharts(chartID);
            // Resize after render to ensure proper layout
            myChart.addEventListener('rendered', function () {
                $('#' + cID).css({
                    'float': 'right',  // This aligns the second chart to the right
                    'width': newWidth + 'px',
                    'height': newHeight + 'px'
                });
                myChart.resizeTo(newWidth, newHeight);
            });
            myChart.setJSONData(data);

            myChart.addEventListener("dataPlotClick", function (event, data) {
                console.log("Data plot clicked:", data);
                alert("You clicked on " + data.categoryLabel + " with a value of " + data.dataValue);
                const ddLink = "dislinkDrillDown209393%C3%82%C2%A0%drilldownID1%=" + data.dataValue + "%C3%82%C2%A0%drilldowncaption%='" + data.categoryLabel + "'%C3%82%C2%A0";
                console.log(ddLink);
                document.location.href = ddLink;
            });
        })
        .catch(function (error) {
            console.error(error.message);
        });

    // Create a new chart using col 3 data
    loadJsonFromDTCol(compID, 3)
        .then(function (data) {
            // Return an object with branch names as keys and counts as values
            const branchCount = Object.fromEntries([...data.reduce((m, o) => m.set(o.BranchName, (m.get(o.BranchName) || 0) + 1), new Map()).entries()]);
            // Convert to FusionCharts data format
            const chartData = [];
            for (const [branchName, count] of Object.entries(branchCount)) {
                chartData.push({ label: branchName, value: count });
            }
            // Create the chart new (don't overwrite an existing one)
            const newChart = new FusionCharts({
                type: 'column2d',
                renderAt: 'newFC',
                width: newWidth,
                height: newHeight,
                dataFormat: 'json',
                dataSource: {
                    chart: {
                        caption: 'Orders by Branch',
                        subCaption: '',
                        xAxisName: 'Branch',
                        yAxisName: 'Number of Orders',
                        theme: 'fusion',
                        bgColor: 'FFFFFF',
                        bgAlpha: '100'
                    },
                    data: chartData
                }
            });
            newChart.render();

        })
        .catch(function (error) {
            console.error(error.message);
        });
    // Resize the data table container so that all the components fill the screen
    $("#dtGrid").css({ "width": newWidth + "px", "height": newHeight + "px" });
});
</code>
</pre>
                    </div>
                    <!-- End FusionCharts Code Block -->

                    <div class="d-flex flex-column flex-md-row mb-5">
                        <div class="me-md-4 mb-3 mb-md-0 text-center">
                            <a href="images/example-chartsjs.png">
                                <img src="images/example-chartsjs.png"
                                    class="img-fluid img-thumbnail img-thumbnail-custom"
                                    alt="FusionCharts Example Dashboard">
                            </a>
                        </div>
                        <div>
                            <h3 class="mt-0 mb-3">Charts.js QlikView Gauge</h3>
                            <p>
                                <a href="chartsjs-example.html" class="btn btn-sm btn-custom-blue me-2"><i
                                        class="bi bi-arrow-right-circle me-2"></i>Example 1</a>:
                                Creates QlikView style gauges and a pie chart using Chart.js. Two of the gauges are
                                bound to
                                an onSelect event that allows users to view data for different weeks.
                            </p>
                        </div>
                    </div>

                    <!-- QV Gauge Code Block -->
                    <h4 class="mt-4 mb-2">QlikView Gauge Example</h4>
                    <div class="code-snippet-container mb-5">
                        <button class="btn btn-sm btn-custom-blue copy-btn" data-clipboard-target="#fusion-code"
                            onclick="copyCode(this)">
                            <i class="bi bi-clipboard me-1"></i>Copy
                        </button>
                        <pre class="bg-dark text-white p-3 rounded-3 shadow">
<code id="fusion-code">
/* Load scripts first:
src="https://cdn.jsdelivr.net/npm/chart.js"
src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous">
*/
// Epicor blue
const epicorBlue = "rgb(49,144,214)";
// Epicor light gray
const epicorLightGray = "rgb(239,243,239)";

function getBgColor(pctCompl) {
  if (pctCompl < 50) {
    return "red";
  } else if (pctCompl < 75) {
    return "orange";
  } else {
    return epicorBlue; // Use the Epicor blue color for 75% and above
  }
}

function getLabelAndPct(data) {
  const retObj = { label: "", percent: 0 };

  if (data.datasets[0].data[0] + data.datasets[0].data[1] != 0) {
    // Add the two values to arrive a full dataset and then divide and round to derive a percentage.
    retObj.percent = Math.round(
      (data.datasets[0].data[0] /
        (data.datasets[0].data[0] + data.datasets[0].data[1])) *
        100
    );
    retObj.label = retObj.percent.toString() + "%";
    if (retObj.percent === 0) {
      // If the percentage is 0, swap the values to create a full red chart
      data.datasets[0].data[0] = data.datasets[0].data[1];
      data.datasets[0].data[1] = 0;
    } // Force a value to make the chart render; all 0s will make an empty chart
  } else {
    // Force a value to make the chart render; all 0s will make an empty chart
    retObj.label = "-";
    data.datasets[0].data[1] = 1;
  }
  return retObj;
}

function createQVDonut(data) {
  // Get the label and percentage completed
  const { label: innerLabel, percent } = getLabelAndPct(data);
  // Set the background color based on the percentage completed
  data.datasets[0].backgroundColor[0] = getBgColor(percent);

  // Draw the inner circle with text
  const circleLabel = {
    id: "circleLabel",
    label: innerLabel,
    // Mimic the Qlikview gauge by drawing a circle and adding the label inside
    beforeDatasetsDraw(chart, args, plugins) {
      const { ctx, data, options } = chart;
      // Grab the x, y location data for the inner most (only) dataset as the inner circle boundary
      const x = chart.getDatasetMeta(0).data[0].x;
      const y = chart.getDatasetMeta(0).data[0].y;
      const angle = Math.PI / 180;
      const datasetLength = data.datasets.length - 1;
      const radius =
        chart.getDatasetMeta(datasetLength).data[0].innerRadius -
        options.borderWidth;
      // Save the canvas to restore later
      ctx.save();
      // Move to the x, y and draw a circle
      ctx.translate(x, y);
      ctx.beginPath();
      ctx.fillStyle = "white";
      ctx.arc(0, 0, radius, 0, angle * 360, false);
      ctx.fill();
      // Add the label and center
      ctx.font = "bold 60px sans-serif";
      ctx.fillStyle = "black";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      // text, x, y
      ctx.fillText(this.label, 0, -10);
      // Add a second label of different size underneath. Note the fillText() method ignores \n
      ctx.font = "25px sans-serif";
      ctx.fillText(data.label2, 0, 25);
      ctx.restore();
    },
  };

  const config = {
    type: "doughnut",
    data,
    options: {
      // Set to false to use the canvas element's size
      responsive: true,
      rotation: 180,
      hoverOffset: 20,
      // Size of the donut hole
      cutout: "70%",
      borderWidth: 0,
      plugins: {
        legend: {
          display: false,
        },
        title: {
          display: true,
          text: data.title,
          color: "black",
          position: "bottom",
          align: "center",
          font: { weight: "bold" },
        },
      },
    },
    plugins: [circleLabel],
  };

  const ctx = document.getElementById(data.id).getContext("2d");
  const myChart = new Chart(ctx, config);
}

$(document).ready(function () {
    createQVDonut(
        getChartConfig(
            "cyc_acc_cur",
            "Cycle Counts Accuracy",
            "Accurate",
            [
                cycData[lastWeek][dataIndices.accurate],
                cycData[lastWeek][dataIndices.inaccurate],
            ]
        )
    );
});
</code>
</pre>
                    </div>
                    <!-- End QV Gauge Code Block -->
                </section>
                <!-- End Charting -->

                <hr class="my-5">

                <!-- Begin Dynamic Dashboard Drilldowns -->
                <section class="mb-5">
                    <h2 class="mb-4">Dynamic Dashboard Drilldowns</h2>
                    <div class="d-flex flex-column flex-md-row">
                        <div class="me-md-4 mb-3 mb-md-0 text-center">
                            <a href="images/db-drilldowns.png">
                                <img src="images/db-drilldowns.png" class="img-fluid img-thumbnail img-thumbnail-custom"
                                    alt="Dashboard Drilldowns">
                            </a>
                        </div>
                        <div>
                            <p class="mt-3 mt-md-0">
                                Import the <a href="dashboards/db-drilldowns.xml" download
                                    class="btn btn-sm btn-outline-secondary py-0 px-2"><i class="bi bi-download"></i>
                                    Dashboard Drilldowns XML</a> into BisTrack to see examples of dynamic dashboards
                                with drilldowns. The import will also create a TEST SmartView to view the passed values
                                and a "Drilldowns 2" dashboard that illustrates passing JSON in session storage to avoid
                                a database retrieval. Note that the "Report Example" can not be imported/exported and
                                must be manually assigned to the Text Line component to work.
                            </p>
                        </div>
                    </div>
                </section>
                <!-- End Dynamic Dashboard Drilldowns -->

                <hr class="my-5">

                <!-- Begin Creating JSON with SQL -->
                <section id="CreatingJSON" class="mb-5">
                    <h2 class="mb-4">Creating JSON with SQL</h2>

                    <!-- Button Group for Snippet Selection -->
                    <div id="sql-button-group" class="d-flex flex-wrap gap-2 mb-3">
                        <button class="btn btn-sm btn-outline-primary"
                            onclick="displaySqlCode('j1', this, 'sql-code', 'sql-button-group')">Auto
                            (Basic)</button>
                        <button class="btn btn-sm btn-outline-primary"
                            onclick="displaySqlCode('j2', this, 'sql-code', 'sql-button-group')">Auto
                            (Root)</button>
                        <button class="btn btn-sm btn-outline-primary"
                            onclick="displaySqlCode('j3', this, 'sql-code', 'sql-button-group')">Path
                            (Basic)</button>
                        <button class="btn btn-sm btn-outline-primary"
                            onclick="displaySqlCode('j4', this, 'sql-code', 'sql-button-group')">Path (dot
                            notation)</button>
                        <button class="btn btn-sm btn-outline-primary"
                            onclick="displaySqlCode('j5', this, 'sql-code', 'sql-button-group')">Path
                            (Subqueries)</button>
                        <button class="btn btn-sm btn-outline-primary"
                            onclick="displaySqlCode('j6', this, 'sql-code', 'sql-button-group')">Object
                            Multiple Props</button>
                        <button class="btn btn-sm btn-outline-primary"
                            onclick="displaySqlCode('j7', this, 'sql-code', 'sql-button-group')">Values as
                            Keys</button>
                        <button class="btn btn-sm btn-outline-primary"
                            onclick="displaySqlCode('j8', this, 'sql-code', 'sql-button-group')">JSON
                            Array</button>
                        <button class="btn btn-sm btn-outline-primary"
                            onclick="displaySqlCode('j9', this, 'sql-code', 'sql-button-group')">Main Dashboard</button>
                    </div>

                    <!-- SQL Code Block Container -->
                    <h4 class="mt-4 mb-2">SQL Example</h4>
                    <div class="code-snippet-container mb-4">
                        <button class="btn btn-sm btn-custom-blue copy-btn" data-clipboard-target="#sql-code"
                            onclick="copyCode(this)">
                            <i class="bi bi-clipboard me-1"></i>Copy
                        </button>
                        <pre class="bg-dark text-white p-3 rounded-3 shadow">
<code id="sql-code">
-- Click one of the buttons above to load an SQL JSON generation example.
</code>
</pre>
                    </div>
                </section>
                <!-- End Creating JSON with SQL -->

                <hr class="my-5">

                <!-- Begin Reading JSON with SQL -->
                <section class="mb-5">
                    <h2 class="mb-4">Reading JSON with SQL</h2>

                    <!-- Button Group for Snippet Selection -->
                    <div id="rsql-button-group" class="d-flex flex-wrap gap-2 mb-3">
                        <button class="btn btn-sm btn-outline-primary"
                            onclick="displaySqlCode('rj1', this, 'rsql-code', 'rsql-button-group')">Read
                            Root</button>
                        <button class="btn btn-sm btn-outline-primary"
                            onclick="displaySqlCode('rj2', this, 'rsql-code', 'rsql-button-group')">Object
                            (Subarrays)</button>
                        <button class="btn btn-sm btn-outline-primary"
                            onclick="displaySqlCode('rj3', this, 'rsql-code', 'rsql-button-group')">WMS Pulse</button>
                        <button class="btn btn-sm btn-outline-primary"
                            onclick="displaySqlCode('rj4', this, 'rsql-code', 'rsql-button-group')">WMS Pulse
                            (data)</button>
                    </div>

                    <!-- SQL Code Block Container -->
                    <h4 class="mt-4 mb-2">SQL Example</h4>
                    <div class="code-snippet-container mb-4">
                        <button class="btn btn-sm btn-custom-blue copy-btn" data-clipboard-target="#rsql-code"
                            onclick="copyCode(this)">
                            <i class="bi bi-clipboard me-1"></i>Copy
                        </button>
                        <pre class="bg-dark text-white p-3 rounded-3 shadow">
<code id="rsql-code">
-- Click one of the buttons above to load an SQL JSON generation example.
</code>
</pre>
                    </div>
                </section>
                <!-- End Reading JSON with SQL -->

            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize tooltips everywhere on the page
        document.addEventListener('DOMContentLoaded', function () {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            })
        }, false);

        function loadFileAsText(url) {
            return $.get(url); // Returns a Promise-like jqXHR object
        }

        const sqlFiles = {
            j1: 'sql/j1-auto.sql',
            j2: 'sql/j2-root.sql',
            j3: 'sql/j3-path-basic.sql',
            j4: 'sql/j4-path-dot.sql',
            j5: 'sql/j5-path-subquery.sql',
            j6: 'sql/j6-multi-prop.sql',
            j7: 'sql/j7-adv-keys.sql',
            j8: 'sql/j8-adv-array.sql',
            j9: 'sql/j9-dashboard.sql',
            rj1: 'sql/rj1-root-ex.sql',
            rj2: 'sql/rj2-subarrays.sql',
            rj3: 'sql/rj3-pulse.sql',
            rj4: 'sql/rj4-pulse-data.sql',
        };

        const sqlSnippets = {};
        for (const key in sqlFiles) {
            loadFileAsText(sqlFiles[key]).then(text => {
                sqlSnippets[key] = text;
            }).catch(err => {
                console.error('Failed to load file:', err.statusText);
            });
        }

        /**
         * Copies the content of a target element (identified by data-clipboard-target)
         * to the clipboard and provides temporary visual confirmation.
         * @param {HTMLElement} button - The button element that was clicked.
         */
        function copyCode(button) {
            const targetId = button.getAttribute('data-clipboard-target');
            // Select the code element within the pre block
            const targetElement = document.querySelector(targetId);

            if (targetElement) {
                // Use document.execCommand('copy') as navigator.clipboard.writeText()
                // may be restricted in some embedded environments (iframes/Canvas)

                // Temporary element to hold the text content (ensures only raw code is copied)
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = targetElement.textContent;

                // Hide the element visually
                tempTextArea.style.position = 'fixed';
                tempTextArea.style.top = '0';
                tempTextArea.style.left = '0';
                tempTextArea.style.opacity = '0';

                document.body.appendChild(tempTextArea);
                tempTextArea.focus();
                tempTextArea.select();

                try {
                    const success = document.execCommand('copy');

                    if (success) {
                        // Success feedback
                        const originalText = button.innerHTML;
                        button.innerHTML = '<i class="bi bi-check-lg me-1"></i>Copied!';

                        // Revert text after a short delay
                        setTimeout(() => {
                            button.innerHTML = originalText;
                        }, 2000);
                    } else {
                        console.error('Copy command was unsuccessful.');
                    }
                } catch (err) {
                    console.error('Failed to execute copy command:', err);
                } finally {
                    // Clean up the temporary element
                    document.body.removeChild(tempTextArea);
                }
            } else {
                console.error("Target element not found.");
            }
        }

        /**
         * Loads the selected SQL code snippet into the code block and updates button state.
         * @param {string} key - The key corresponding to the snippet in sqlSnippets.
         * @param {HTMLElement} selectedButton - The button element that was clicked.
         */
        function displaySqlCode(key, selectedButton, codeBlockID, buttonGroupID) {
            const codeBlock = document.getElementById(codeBlockID);
            const buttonGroup = document.getElementById(buttonGroupID);

            if (codeBlock && sqlSnippets[key]) {
                codeBlock.textContent = sqlSnippets[key];
            } else {
                codeBlock.textContent = `-- Error: Code snippet for key "${key}" not found.`;
                return;
            }

            // Update button styles (active/inactive)
            if (buttonGroup) {
                const buttons = buttonGroup.querySelectorAll('button');
                buttons.forEach(btn => {
                    // Remove primary style and add outline style to all
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-outline-primary');
                });

                // Add primary style to the selected button
                selectedButton.classList.remove('btn-outline-primary');
                selectedButton.classList.add('btn-primary');
            }
        }
    </script>
</body>

</html>