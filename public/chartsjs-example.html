<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Charts.js Example</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
</head>

<body>
    <div class="container-fluid px-5">
        <h3 class="pt-5 pb-4">Cycle Counts & Put Aways</h3>
        <div class="row mt-1">
            <div class="">
                <p class="h4 align-bottom p-2">Current Week</p>
            </div>
            <div class="d-flex align-items-start flex-row">
                <div class="border p-2">
                    <canvas id="cyc_compl_cur"></canvas>
                </div>
                <div class="border p-2">
                    <canvas id="cyc_acc_cur"></canvas>
                </div>
                <div class="border p-2">
                    <canvas id="pa_complete"></canvas>
                </div>
            </div>
            <div class="">
                <p class="h4 align-bottom p-2">Last Two Months</p>
            </div>
            <div class="d-flex align-items-start flex-row" id="cycCurrent">
                <div class="border p-2"><canvas id="cyc_compl_sel"></canvas></div>
                <div class="border p-2"><canvas id="cyc_acc_sel"></canvas></div>
                <div class="border p-2"><canvas id="pa_by_loc"></canvas></div>
            </div>
            <div class="align-items-start flex-row w-25" id="cycDropdown">
                <div class="p-2">
                    <label for="dateDropdown">Select a week:</label>
                    <select id="dateDropdown" class="form-select">
                        <option>Loading dates...</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="scripts/chart-utils.js"></script>
    <script src="scripts/btpi-utils.js"></script>
    <script>
        $(document).ready(function () {
            /* ------------------------ CYCLE COUNTS ------------------------- */
            // Load the cycle count summary data from the JSON file using jQuery's getJSON method
            const cyc_counts = "data/db_cycle_ct_summary.json";
            $.getJSON(cyc_counts, function (data) {
                if (data && data.data && data.data.length > 0) {
                    // Find the index of the "Begin Date" column in the first row of data
                    const weekIndex = data.data[0].findIndex(
                        (item) => item.name === "Begin Date"
                    );
                    // Object of indices for the data we want to track
                    const dataIndices = {
                        required: 0,
                        complete: 1,
                        incomplete: 2,
                        accurate: 3,
                        inaccurate: 4,
                    };
                    // Create a flat array with the same length as the number of data indices. Initialize with 0s.
                    const initArray = createFlatArray(dataIndices);
                    // Main object of arrays; each key will be a week date, and the value will be an array of data
                    // The array will have the same length as the dataIndices object
                    let cycData = {};
                    // Create a key for the running total of all weeks
                    const lblAllWeeks = "All Weeks";
                    cycData[lblAllWeeks] = initArray.slice();
                    let lastWeek = "";
                    // Loop through each row of data
                    $.each(data.data, function (i, row) {
                        if (!cycData[row[weekIndex].value]) {
                            // Create a key named for the week and copy the initial array to the new week entry
                            // Each week will have a corresponding array of data to increment according to the dataIndices
                            cycData[row[weekIndex].value] = initArray.slice();
                        }
                        lastWeek = row[weekIndex].value;
                        // Loop through each cell in the row, incrementing the appropriate index in the cycData array
                        // based on the column name
                        $.each(row, function (j, cell) {
                            if (cell.name === "Required Locs") {
                                // Increment the required count for the week
                                cycData[row[weekIndex].value][dataIndices.required] +=
                                    parseInt(cell.value) || 0;
                                cycData[lblAllWeeks][dataIndices.required] +=
                                    parseInt(cell.value) || 0;
                            } else if (cell.name === "Completed Locs") {
                                // Increment the complete count for the week
                                cycData[row[weekIndex].value][dataIndices.complete] +=
                                    parseInt(cell.value) || 0;
                                cycData[lblAllWeeks][dataIndices.complete] +=
                                    parseInt(cell.value) || 0;
                            } else if (cell.name === "Incomplete Locs") {
                                // Increment the incomplete count for the week
                                cycData[row[weekIndex].value][dataIndices.incomplete] +=
                                    parseInt(cell.value) || 0;
                                cycData[lblAllWeeks][dataIndices.incomplete] +=
                                    parseInt(cell.value) || 0;
                            } else if (cell.name === "Total Correct") {
                                // Increment the accurate count for the week
                                cycData[row[weekIndex].value][dataIndices.accurate] +=
                                    parseInt(cell.value) || 0;
                                cycData[lblAllWeeks][dataIndices.accurate] +=
                                    parseInt(cell.value) || 0;
                            } else if (cell.name === "Total Incorrect") {
                                // Increment the inaccurate count for the week
                                cycData[row[weekIndex].value][dataIndices.inaccurate] +=
                                    parseInt(cell.value) || 0;
                                cycData[lblAllWeeks][dataIndices.inaccurate] +=
                                    parseInt(cell.value) || 0;
                            }
                        });
                    });

                    // Debug: Log the cycData object to the console
                    console.log(cycData)

                    // Render the current week charts
                    createQVDonut(
                        getChartConfig(
                            "cyc_compl_cur",
                            "Cycle Counts Completed",
                            "Completed",
                            [
                                cycData[lastWeek][dataIndices.complete],
                                cycData[lastWeek][dataIndices.incomplete],
                            ]
                        )
                    );
                    createQVDonut(
                        getChartConfig(
                            "cyc_acc_cur",
                            "Cycle Counts Accuracy",
                            "Accurate",
                            [
                                cycData[lastWeek][dataIndices.accurate],
                                cycData[lastWeek][dataIndices.inaccurate],
                            ]
                        )
                    );

                    // Render the selection charts
                    createQVDonut(
                        getChartConfig(
                            "cyc_compl_sel",
                            lblAllWeeks + " CC Completed",
                            "Completed",
                            [
                                cycData[lblAllWeeks][dataIndices.complete],
                                cycData[lblAllWeeks][dataIndices.incomplete],
                            ]
                        )
                    );
                    createQVDonut(
                        getChartConfig(
                            "cyc_acc_sel",
                            lblAllWeeks + " CC Accuracy",
                            "Accurate",
                            [
                                cycData[lblAllWeeks][dataIndices.accurate],
                                cycData[lblAllWeeks][dataIndices.inaccurate],
                            ]
                        )
                    );

                    // Create the dropdown options
                    const $dateDropdown = $("#dateDropdown");
                    $dateDropdown.empty(); // Clear the "Loading dates..." option
                    $dateDropdown.append($("<option>").text("Choose..."));

                    // Populate the dropdown with week dates
                    $.each(cycData, function (i, date) {
                        $dateDropdown.append($("<option>").text(i));
                    });

                    // Bind the change event to the dropdown
                    $dateDropdown.on("change", function () {
                        // selVal is the selected week date or "All"
                        const selVal = $(this).val();
                        // Get the "Completed Selected" chart and update it with the selected week data
                        const compChart = Chart.getChart("cyc_compl_sel");
                        // This logic could be refactored into a function to reduce redundancy
                        if (compChart) {
                            if (selVal && cycData[selVal]) {
                                // Selected dataset
                                const data = [
                                    cycData[selVal][dataIndices.complete],
                                    cycData[selVal][dataIndices.incomplete],
                                ];
                                // Get a new chart config to pass to getLabelAndPct
                                const fullconfig = getChartConfig(
                                    "cyc_compl_sel",
                                    "",
                                    "Completed",
                                    data
                                );
                                // Get the inner label and percentage accurate values; account for division by 0 and 0% case. Note the getLabelAndPct function will update the dataset as needed.
                                const { label: innerLabel, percent } = getLabelAndPct(fullconfig);
                                // Update the chart data
                                compChart.data.datasets[0].data = data;
                                // Update the chart title
                                compChart.options.plugins.title.text = selVal + " Completed";
                                // Set the background color based on the percentage accurate
                                compChart.data.datasets[0].backgroundColor[0] = getBgColor(percent);
                                // Update the inner label (plugin) with the percentage completed label
                                compChart.config.plugins[0].label = innerLabel
                                // Redraw the chart with the new data
                                compChart.update();
                            } else {
                                console.warn("Selected value not found in cycData");
                            }

                        } else {
                            console.error("cyc_compl_sel chart not found");
                        }
                        // Get the "Accuracy Selected" chart and update it with the selected week data
                        const accChart = Chart.getChart("cyc_acc_sel"); // <canvas> id
                        if (accChart) {
                            if (selVal && cycData[selVal]) {
                                // Selected dataset
                                const data = [
                                    cycData[selVal][dataIndices.accurate],
                                    cycData[selVal][dataIndices.inaccurate],
                                ];
                                // Get a new chart config to pass to getLabelAndPct
                                const fullconfig = getChartConfig(
                                    "cyc_acc_sel",
                                    "",
                                    "Accurate",
                                    data
                                );
                                // Get the inner label and percentage accurate values; account for division by 0 and 0% case. Note the getLabelAndPct function will update the dataset as needed.
                                const { label: innerLabel, percent } = getLabelAndPct(fullconfig);
                                // Update the chart data
                                accChart.data.datasets[0].data = data;
                                // Update the chart title
                                accChart.options.plugins.title.text = selVal + " Accuracy";
                                // Set the background color based on the percentage accurate
                                accChart.data.datasets[0].backgroundColor[0] = getBgColor(percent);
                                // Update the inner label (plugin) with the percentage accurate label
                                accChart.config.plugins[0].label = innerLabel
                                // Redraw the chart with the new data
                                accChart.update();
                            } else {
                                console.warn("Selected value not found in cycData");
                            }
                        } else {
                            console.error("cyc_acc_sel chart not found");
                        }
                    });
                } else {
                    console.error("No cycle count data found");
                }
            }).fail(function (xhr, textstatus, error) {
                console.error(
                    `Error loading JSON file ${cyc_counts}: ${textstatus}, ${error}`
                );
            });

            /* ------------------------ COMPLETED PUT AWAYS ------------------------- */
            // Put Aways using the newly discovered TasksB endpoint; requires the TasksB
            // Query be enabled in config/queries.json
            const tasksB = "data/tasksb.json";
            $.getJSON(tasksB, function (data) {
                // Find the object with the "Put Aways" task
                const paObj = data.find(
                    (obj) => obj.hasOwnProperty("Task") && obj["Task"] === "Put Aways"
                );
                if (paObj) {
                    createQVDonut(
                        getChartConfig("pa_complete", "Put Aways Complete", "Completed", [
                            paObj.Completed,
                            paObj.TO_DO,
                        ])
                    );
                } else {
                    console.error("Put Aways not found on the TasksB object");
                }
            }).fail(function (xhr, textstatus, error) {
                console.error(
                    `Error loading JSON file ${tasksB}: ${textstatus}, ${error}`
                );
            });

            /* ------------------------ PUT AWAYS BY LOCATION ------------------------- */
            const pa_by_loc = "data/db_pa_by_loc.json";
            $.getJSON(pa_by_loc, function (data) {
                // Register the Chart.js Data Labels plugin
                // Chart.register(ChartDataLabels);
                if (data.data && data.data.length > 0) {
                    let paData = [];
                    $.each(data.data, function (i, item) {
                        let line = { loc: undefined, cnt: undefined };
                        $.each(item, function (j, cell) {
                            // Check if the cell is a location and count
                            if (cell.name === "LOCATION") {
                                line.loc = cell.value;
                            } else if (cell.name === "PA_ITEMS") {
                                line.cnt = parseInt(cell.value) || 0;
                            }
                            // If we have both location and count, add to the data array
                            if (line.loc && line.cnt) {
                                paData.push(line);
                            }
                        });
                    });
                    // Sort by count descending to make a more visually appealing chart
                    paData.sort((a, b) => b.cnt - a.cnt);

                    const pas = {};
                    let ttlPAs = 0;
                    // Use the location as the key (series names) and the count as the value
                    paData.forEach((item, index) => {
                        pas[item.loc] = item.cnt;
                        ttlPAs += parseInt(item.cnt);
                    });

                    const paConfig = getPieChartConfig(
                        pas,
                        "pa_by_loc",
                        "Put aways at location",
                        ttlPAs + " Put aways",
                        3
                    );
                    const custCtx = document
                        .getElementById(paConfig.id)
                        .getContext("2d");
                    new Chart(custCtx, paConfig);
                } else {
                    console.warn("No data found");
                }
            }).fail(function (xhr, textstatus, error) {
                console.error(
                    `Error loading JSON file ${pa_by_loc}: ${textstatus}, ${error}`
                );
            });
        });
    </script>
</body>

</html>